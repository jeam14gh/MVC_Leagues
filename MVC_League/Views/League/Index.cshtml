@model IEnumerable<MVC_League.Entities.League>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-lg-4 col-lg-offset-4 text-center">
        <h1></h1>
    </div>
    <div class="col-lg-4 col-lg-offset-4" id="tblLeagues">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="label-default">
                    <tr>
                        <th>
                            @Html.DisplayNameFor(model => model.Name)
                        </th>
                        <th colspan="4" class="text-right">
                            <button type="button" data-toggle="tooltip" title="Agregar" data-action="add" onclick="fnAdmin(this)">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                            @*@Html.ActionLink("Agregar nueva liga", "Create", null, new { @class = "btn btn-success btn-block" })*@
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td id="@item.Id">
                                @Html.DisplayFor(modelItem => item.Name)
                            </td>
                            <td class="text-right">
                                <button type="button" data-toggle="tooltip" title="Editar" data-leagueId=@item.Id data-action="update" onclick="fnAdmin(this)">
                                    <span class="glyphicon glyphicon-pencil"></span>
                                </button>
                                @*@Html.ActionLink("Edit", "Edit", new { id = item.Id },new { leagueId = item.Id, onclick = "fnAdmin(this)"}) |*@
                                @*@Html.ActionLink("Delete", "Delete", new { id = item.Id })*@
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-lg-4 col-lg-offset-4 hidden" id="divAdminLeague">
        <div id="title" class="col-sm-12">

        </div>
        <div class="form-inline row">
            <div class="form-group col-sm-8">
                <input type="text" id="txtLeague" class="form-control" />
            </div>
            <div class="form-group col-sm-2">
                <button type="button" data-toggle="tooltip" title="Guardar" class="btn btn-success" onclick="fnSaveLeague(this)">
                    <i class="glyphicon glyphicon-floppy-disk"></i>
                </button>
            </div>
            <div class="form-group col-sm-2">
                <button type="button" data-toggle="tooltip" title="Cancelar" class="btn btn-danger" onclick="fnCancel()">
                    <i class="glyphicon glyphicon-remove"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section applicationScripts {
    <script type="text/javascript">
        var
            _action = null;

        function fnAdmin(e) {
            var
                name = $(e).parent().siblings().text().trim(),
                leagueId = e.dataset["leagueid"];

            _action = $(e).data("action");

            $("#tblLeagues").addClass("hidden");
            $("#divAdminLeague").removeClass("hidden");

            $("div#title").children().remove();
            if (_action == "add") {
                $("div#title").append("<h1>Agregar Liga</h1>");
            }
            else if (_action == "update") {
                $("div#title").append("<h1>Editar Liga</h1>");
                $("#tblLeagues").addClass("hidden");
                $("#txtLeague").val(name);
                $("#txtLeague").attr("data-leagueid", leagueId);
            }

        }

        function fnCancel() {
            $("#tblLeagues").removeClass("hidden");
            $("#divAdminLeague").addClass("hidden");
            $("#txtLeague").val('');
        }

        function fnSaveLeague(e) {
            var
                name = $("#txtLeague").val();

            if (!name) {
                alert("Ingrese un nombre por favor!")
                return;
            }

            if (_action == "add") {

                $.ajax({
                    url: "Create",
                    method: "POST",
                    data: JSON.stringify({ league: { Name: name } }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        var tr = "<tr>"+
                                    "<td id='" + response.Id + "'>" +
                                        response.Name +
                                    "</td>" +
                                    "<td class='text-right'>"+
                                        "<button type='button' data-toggle='tooltip' title='Editar' data-leagueId='" + response.Id + "' data-action='update' onclick='fnAdmin(this)'>"+
                                            "<span class='glyphicon glyphicon-pencil'></span>"+
                                        "</button>"+
                                    "</td>"+
                                "</tr>";
                        $("#tblLeagues tbody").append(tr);
                        fnCancel();
                        _leagues.push(response);
                        alert("Liga creada correctamente!")
                    },
                    error: function (jqXHR, textStatus) {
                        var err = textStatus + ", " + jqXHR;
                        alert("Error al generar el archivo. " + err);
                    }
                });
            }
            else if (_action == "update") {
                var 
                    id = $("#txtLeague").attr("data-leagueid");

                $.ajax({
                    url: "Edit",
                    method: "POST",
                    data: JSON.stringify({ league: { Name: name, Id: id } }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        var league = _leagues.find(f=>f.Id == id);
                        if (league !== undefined) {
                            league.Name = name;
                        }

                        $("td#" + id).text(name);
                        fnCancel();
                        alert("Liga actualizada correctamente!")
                    },
                    error: function (jqXHR, textStatus) {
                        var err = textStatus + ", " + jqXHR;
                        alert("Error al generar el archivo. " + err);
                    }
                });
            }
        }
    </script>
}
